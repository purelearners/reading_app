<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reading Practice with Jumbled Words - Homophone Safe</title>
<style>
/* Styles same as previous for brevity */
body { font-family: 'Comic Sans MS', cursive, sans-serif; background: #fcf8f3; padding: 20px; min-height: 100vh; margin: 0; }
#levelDisplay { font-size: 24px; font-weight: 900; color: #27ae60; margin-bottom: 10px; }
#jumbleContainer { display: none; width: 100%; order: -1; margin-bottom: 20px;}
#sentenceBox, #correctSentenceBox { border-radius: 12px; border: 3px solid #6ab04c; background: #d4efdf; padding: 30px 20px; width: 70%; max-width: 700px; text-align: center; font-weight: bold; font-size: 28px; color: #34495e; min-height: 80px; display: flex; justify-content: center; align-items: center; margin-bottom: 15px; transition: opacity 0.6s ease, transform 0.6s ease;}
#sentenceBox.active, #correctSentenceBox.active { opacity: 1; transform: scale(1); }
#sentenceBox.hidden, #correctSentenceBox.hidden { display: none; }
#correctSentenceBox { background: #d5f4e6; border: 3px solid #27ae60; color: #27ae60; min-height: 50px; font-size: 22px; margin: 10px auto 20px; }
#spokenSentenceBox { border: 3px solid #3498db; background: #d6eaf8; padding: 20px; border-radius: 12px; width: 70%; max-width: 700px; font-weight: bold; font-size: 22px; color: #2c3e50; margin-bottom: 15px; min-height: 80px; display: none; flex-direction: column; justify-content: center; align-items: center;}
#spokenSentenceBox.active{ display:flex; }
#playbackContainer { margin-top: 15px; display: flex; justify-content:center; gap: 10px;}
.playback-button { background:#3498db; border:none; color:white; border-radius:50%; width:50px; height:50px; font-size:24px; cursor:pointer; display:flex; justify-content:center; align-items:center; transition:background-color 0.3s; box-shadow: 0 4px 6px -1px rgba(52,152,219,0.6);}
.playback-button:hover:not(:disabled) { background:#2980b9 }
.playback-button:disabled { background:#95a5a6; cursor:default; }
#buttons { margin-bottom: 20px; }
button { font-size: 18px; margin: 0 10px; padding: 12px 25px; border-radius: 10px; border:none; background:#6ab04c; color:white; cursor:pointer; box-shadow:0 4px 6px -1px rgba(106,176,76,0.6); transition:background-color 0.3s; }
button:hover:not(:disabled) {background:#4a8e2f;}
button:disabled {background:#b5d6a1; cursor:default;}
#recallBtn, #showSentenceBtn, #nextSentenceBtn, #continueBtn, #restartBtn, #retryBtn { display:none; background:#3498db; box-shadow:0 4px 6px -1px rgba(52,152,219,0.6);}
#recallBtn:hover:not(:disabled), #showSentenceBtn:hover:not(:disabled), #nextSentenceBtn:hover:not(:disabled), #continueBtn:hover:not(:disabled), #restartBtn:hover:not(:disabled), #retryBtn:hover:not(:disabled) {background:#2980b9;}
#result { font-size: 20px; font-weight: 700; height: 28px; margin-bottom: 10px; color:#2c3e50; }
#instructions { font-size: 16px; color: #34495e; margin: 0 0 15px; font-weight: 600; }
.container-label { font-size: 14px; font-weight: 700; color: #34495e; margin-bottom: 5px;}
#jumbleContentWrapper { display:block; width:100%; }
#jumbleContentWrapper.hidden { display:none; }
#jumbledWords, #assembledWords { display:flex; flex-wrap:wrap; justify-content:center; padding:15px; min-height:80px; border-radius:12px; max-width:700px; margin: 0 auto 15px; gap: 10px; min-width: 300px; background: #f0f8f5; }
#jumbledWords { border: 2px solid #6ab04c;}
#assembledWords { border: 3px dashed #27ae60; background: #fff;}
.word { background:#81c784; padding: 12px 20px; border-radius: 20px; cursor: pointer; user-select:none; font-size: 18px; color:white; box-shadow: 0 3px 6px #66bb6a; transition:all 0.3s; font-weight:600;}
.word:hover { background:#66bb6a; transform: scale(1.05);}
.word.selected { background:#ff9800; box-shadow: 0 3px 6px #ffb74d;}
#jumbleTimer { font-size: 18px; font-weight: 700; color: #e74c3c; margin-top: 10px; }
</style>
</head>
<body>

<h1>Reading Practice with Jumbled Words</h1>

<div id="levelDisplay"></div>

<div id="jumbleContainer">
  <div id="jumbleContentWrapper">
    <div id="instructions">Click on words to arrange them in the correct order!</div>
    <div class="container-label">Jumbled Words:</div>
    <div id="jumbledWords"></div>
    <div class="container-label">Your Answer:</div>
    <div id="assembledWords"></div>
    <div id="jumbleTimer"></div>
  </div>
</div>

<div id="sentenceBox"></div>

<div id="spokenSentenceBox">
  <div>You said: <strong id="spokenText"></strong></div>
  <div id="playbackContainer">
    <button class="playback-button" id="playbackBtn" title="Play Recording" disabled>â–¶</button>
  </div>
</div>

<div id="correctSentenceBox">
  <strong id="correctSentenceText"></strong>
</div>

<div id="scorePageContainer">
  <div class="score-title">Level Complete!</div>
  <div class="score-content" id="levelScoreContent"></div>
  <button id="continueBtn">Continue to Next Level</button>
  <button id="restartBtn">Restart</button>
</div>

<div id="buttons">
  <button id="repeatBtn">Repeat After Me</button>
  <button id="speakBtn">Speak</button>
  <button id="recallBtn">Recall It</button>
  <button id="retryBtn">Retry</button>
  <button id="showSentenceBtn">Show Sentence</button>
  <button id="nextSentenceBtn">Next Question</button>
</div>

<div id="result"></div>

<script>
const level1Proverbs = [
  /* ... all 70 proverbs from your list ... */
  "Honesty brings trust", "Kindness spreads joy", "Respect earns respect", "Sharing shows care",
  "Patience brings peace", "Manners matter always", "Truth wins always", "Forgive and grow",
  "Help others often", "Be a helper", "Practice makes perfect", "Mistakes teach lessons",
  "Learn from failure", "Curiosity sparks learning", "Questions lead answers", "Reading grows minds",
  "Think before speaking", "Listen and learn", "Try try again", "Never stop learning",
  "Believe in yourself", "Bravery beats fear", "Stand up strong", "Face your fears",
  "Be your best", "Confidence builds success", "Speak with courage", "Keep moving forward",
  "You are enough", "Be fearlessly kind", "Friends stick together", "Teamwork builds dreams",
  "Help your friends", "Share the load", "Laugh with friends", "Apologize when wrong",
  "Include everyone always", "Be a buddy", "Kindness creates friendships", "Together is better",
  "Time teaches everything", "Wait your turn", "Think things through", "Slow down sometimes",
  "Choose words wisely", "Listen before speaking", "Watch and learn", "Dont rush decisions",
  "Patience brings rewards", "Wisdom grows quietly", "Smile every day", "Gratitude brings happiness",
  "Joy is contagious", "Appreciate small things", "Count your blessings", "Stay kind always",
  "Choose happy thoughts", "Laugh every day", "Positivity spreads sunshine", "Be joyfully thankful",
  "Do your best", "Finish your work", "Clean your space", "Take care daily",
  "Be on time", "Follow the rules", "Think before acting", "Own your actions",
  "Keep promises always", "Be a leader"
];

const level2Science = [
  /* ... truncated for brevity, pls include your full list ... */
  "Matter has mass always", "Atoms make molecules together", "Elements are pure substances",
  "Water is liquid form", "Salt dissolves very easily", "Heat speeds chemical reactions",
  "Acids taste quite sour", "Bases feel very slippery", "Mixtures combine different substances",
  "Air contains many gases"
];

const level3Science = [
  /* ... truncated for brevity ... */
  "The water cycle demonstrates evaporation condensation and precipitation continuously",
  "Photosynthesis requires sunlight carbon dioxide water and chlorophyll molecules",
  "Newton first law states objects remain stationary until force applied",
  "Ecosystems depend on producers consumers and decomposers working together",
  "Climate change results from greenhouse gas emissions affecting temperature",
  "DNA carries genetic information determining organism traits and characteristics"
];

const allLevels = [
  { name: "Level 1: Easy - Proverbs & Values", sentences: level1Proverbs, timerLimit: 10, usedIndices: [] },
  { name: "Level 2: Medium - Science", sentences: level2Science, timerLimit: 15, usedIndices: [] },
  { name: "Level 3: Hard - Complex Science", sentences: level3Science, timerLimit: 20, usedIndices: [] }
];

// Homophone groups (add to expand)
const homophoneGroups = [
  ["to","too","two"],
  ["here","hear"],
  ["sea","see"],
  ["right","write"],
  ["flower","flour"],
  ["one","won"],
  ["bare","bear"],
  ["break","brake"]
];

// Returns true if two words are homophones
function areHomophones(word1, word2) {
  word1 = word1.toLowerCase();
  word2 = word2.toLowerCase();
  return homophoneGroups.some(group => group.includes(word1) && group.includes(word2));
}

// Check if user spoken sentence matches expected, handling homophones but requires exact letters otherwise
function speechMatchesStrict(spoken, expected) {
  // Normalize words by removing punctuation, splitting and lowercasing
  const spokenWords = spoken.toLowerCase().replace(/[.,!?]/g, '').trim().split(/\s+/);
  const expectedWords = expected.toLowerCase().replace(/[.,!?]/g, '').trim().split(/\s+/);

  if (spokenWords.length !== expectedWords.length) return false;

  for (let i = 0; i < expectedWords.length; i++) {
    if (spokenWords[i] === expectedWords[i]) continue;
    if (areHomophones(spokenWords[i], expectedWords[i])) continue;
    return false; // If not exact or homophone, fail
  }
  return true;
}

let currentLevel = 0;
let currentQuestion = 0;
let levelScore = 0;
let totalScore = 0;
let jumbleTimerInterval;
let jumbleTimeLeft = 10;
let jumbleTimerLimit = 10;
let timeLimitExceeded = false;
let currentSentence = '';
let levelSentences = [];

const levelDisplay = document.getElementById('levelDisplay');
const sentenceBox = document.getElementById('sentenceBox');
const spokenSentenceBox = document.getElementById('spokenSentenceBox');
const spokenText = document.getElementById('spokenText');
const playbackBtn = document.getElementById('playbackBtn');
const result = document.getElementById('result');
const jumbleTimerDiv = document.getElementById('jumbleTimer');
const repeatBtn = document.getElementById('repeatBtn');
const speakBtn = document.getElementById('speakBtn');
const recallBtn = document.getElementById('recallBtn');
const retryBtn = document.getElementById('retryBtn');
const showSentenceBtn = document.getElementById('showSentenceBtn');
const nextSentenceBtn = document.getElementById('nextSentenceBtn');
const continueBtn = document.getElementById('continueBtn');
const restartBtn = document.getElementById('restartBtn');
const jumbleContainer = document.getElementById('jumbleContainer');
const jumbleContentWrapper = document.getElementById('jumbleContentWrapper');
const jumbledWordsDiv = document.getElementById('jumbledWords');
const assembledWordsDiv = document.getElementById('assembledWords');
const correctSentenceBox = document.getElementById('correctSentenceBox');
const correctSentenceText = document.getElementById('correctSentenceText');
const scorePageContainer = document.getElementById('scorePageContainer');
const levelScoreContent = document.getElementById('levelScoreContent');
const buttons = document.getElementById('buttons');

let recognition;
let micAllowed = false;
let recognitionActive = false;
let mediaRecorder;
let mediaStream;
let audioChunks = [];
let audioBlob;

function getRandomSentences(level, count) {
  const levelData = allLevels[level];
  if (levelData.usedIndices.length >= levelData.sentences.length) {
    levelData.usedIndices = [];
  }
  const availableIndices = [];
  for(let i=0; i < levelData.sentences.length; i++) {
    if (!levelData.usedIndices.includes(i)) {
      availableIndices.push(i);
    }
  }
  const sentences = [];
  for(let i=0; i < count; i++) {
    const idx = availableIndices.splice(Math.floor(Math.random()*availableIndices.length),1)[0];
    levelData.usedIndices.push(idx);
    sentences.push(levelData.sentences[idx]);
  }
  return sentences;
}

function fadeInSentence(text) {
  sentenceBox.classList.remove('active', 'hidden');
  setTimeout(() => {
    sentenceBox.textContent = text;
    sentenceBox.classList.add('active');
  }, 150);
}

function hideSentence() {
  sentenceBox.classList.add('hidden');
  sentenceBox.classList.remove('active');
}

function setupMediaRecorder() {
  return navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    mediaStream = stream;
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = event => {
      audioChunks.push(event.data);
    };
    mediaRecorder.onstop = () => {
      audioBlob = new Blob(audioChunks, {type:'audio/webm'});
      playbackBtn.disabled = false;
    };
  });
}

function initializeSpeechRecognition() {
  if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
    alert('Speech Recognition not supported in this browser.');
    return null;
  }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recog = new SpeechRecognition();
  recog.lang = 'en-US';
  recog.interimResults = false;
  recog.maxAlternatives = 1;
  recog.continuous = false;

  recog.onstart = () => {
    recognitionActive = true;
    speakBtn.textContent = 'Stop Listening';
    result.textContent = 'Listening...';
    audioChunks = [];
    if (mediaRecorder && mediaRecorder.state === 'inactive') {
      mediaRecorder.start();
    }
  };

  recog.onresult = event => {
    recognitionActive = false;
    speakBtn.textContent = 'Speak';
    const spoken = event.results[0][0].transcript;
    if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
    spokenSentenceBox.classList.add('active');
    spokenText.textContent = spoken;

    if (speechMatchesStrict(spoken, currentSentence)) {
      result.textContent = 'Correct!';
      totalScore++; levelScore++;
      speakBtn.style.display = 'none';
      repeatBtn.style.display = 'none';
      recallBtn.style.display = 'inline-block';
      retryBtn.style.display = 'none';
    } else {
      result.textContent = 'Incorrect. Try again!';
      retryBtn.style.display = 'inline-block';
      speakBtn.style.display = 'none';
      repeatBtn.style.display = 'none';
      recallBtn.style.display = 'none';
    }
  };

  recog.onerror = event => {
    recognitionActive = false;
    speakBtn.textContent = 'Speak';
    if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
    if (event.error === 'no-speech') {
      result.textContent = 'No speech detected. Try again!';
    } else if (event.error === 'not-allowed') {
      alert('Mic permission denied.');
      speakBtn.disabled = true;
    } else {
      result.textContent = 'Error: ' + event.error;
    }
  };

  recog.onend = () => {
    recognitionActive = false;
    speakBtn.textContent = 'Speak';
    if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
  };

  return recog;
}

function startReadingPractice() {
  jumbleContainer.style.display = 'none';
  correctSentenceBox.classList.remove('active');
  scorePageContainer.classList.remove('active');
  buttons.style.display = 'block';
  sentenceBox.style.display = 'flex';
  spokenSentenceBox.classList.remove('active');
  result.textContent = '';
  currentLevel = 0; currentQuestion = 0; levelScore = 0; totalScore = 0;
  speakBtn.disabled = false; repeatBtn.disabled = false;
  speakBtn.textContent = 'Speak';
  recallBtn.style.display = 'none'; retryBtn.style.display = 'none';
  showSentenceBtn.style.display = 'none'; nextSentenceBtn.style.display = 'none';
  continueBtn.style.display = 'none'; restartBtn.style.display = 'none';
  speakBtn.style.display = 'inline-block'; repeatBtn.style.display = 'inline-block';
  playbackBtn.disabled = true;

  setupMediaRecorder().then(()=>{
    recognition = initializeSpeechRecognition();
    micAllowed = true;
    showLevel();
  }).catch(err => alert('Mic access required.'));
}

function showLevel() {
  const levelName = allLevels[currentLevel].name;
  levelDisplay.textContent = levelName;
  levelSentences = getRandomSentences(currentLevel, 3);
  currentQuestion = 0; levelScore = 0;
  showQuestion();
}

function showQuestion() {
  levelDisplay.textContent = `${allLevels[currentLevel].name} - Question ${currentQuestion + 1}/3`;
  currentSentence = levelSentences[currentQuestion];
  fadeInSentence(currentSentence);
  result.textContent = '';
  spokenSentenceBox.classList.remove('active');
  jumbleContainer.style.display = 'none';
  correctSentenceBox.classList.remove('active');
  speakBtn.disabled = false;
  repeatBtn.disabled = false;
  speakBtn.textContent = 'Speak';
  recallBtn.style.display = 'none';
  retryBtn.style.display = 'none';
  showSentenceBtn.style.display = 'none';
  nextSentenceBtn.style.display = 'none';
  speakBtn.style.display = 'inline-block';
  repeatBtn.style.display = 'inline-block';
  playbackBtn.disabled = true;
}

function showJumbleActivity(words) {
  hideSentence();
  spokenSentenceBox.classList.remove('active');
  jumbleContainer.style.display = 'block';
  jumbleContentWrapper.classList.remove('hidden');
  correctSentenceBox.classList.remove('active');
  result.textContent = '';
  recallBtn.style.display = 'none';
  retryBtn.style.display = 'none';
  showSentenceBtn.style.display = 'none';
  nextSentenceBtn.style.display = 'none';
  timeLimitExceeded = false;
  jumbleTimerLimit = allLevels[currentLevel].timerLimit;

  const shuffled = [...words].sort(() => Math.random() - 0.5);

  jumbledWordsDiv.innerHTML = '';
  assembledWordsDiv.innerHTML = '';

  shuffled.forEach(word => {
    const div = document.createElement('div');
    div.textContent = word;
    div.classList.add('word');
    div.id = 'word-' + word + '-' + Math.random().toString(36).substr(2,5);
    div.dataset.word = word;
    div.onclick = () => moveWord(div);
    jumbledWordsDiv.appendChild(div);
  });

  assembledWordsDiv.dataset.correctSentence = words.join(' ');
  startJumbleTimer();

  window.scrollTo(0, 0);
}

function moveWord(wordElem) {
  const isInAssembled = assembledWordsDiv.contains(wordElem);
  if (isInAssembled) {
    jumbledWordsDiv.appendChild(wordElem);
  } else {
    assembledWordsDiv.appendChild(wordElem);
    checkSentenceCompletion();
  }
}

function startJumbleTimer() {
  clearInterval(jumbleTimerInterval);
  jumbleTimeLeft = jumbleTimerLimit;
  jumbleTimerDiv.textContent = `Time left: ${jumbleTimeLeft} seconds`;
  jumbleTimerInterval = setInterval(() => {
    jumbleTimeLeft--;
    jumbleTimerDiv.textContent = `Time left: ${jumbleTimeLeft} seconds`;
    if (jumbleTimeLeft <= 0) {
      clearInterval(jumbleTimerInterval);
      jumbleTimerDiv.textContent = "Time's up!";
      result.textContent = "Time's up! No mark awarded.";
      timeLimitExceeded = true;
      showSentenceBtn.style.display = 'inline-block';
      nextSentenceBtn.style.display = 'inline-block';
    }
  }, 1000);
}

function checkSentenceCompletion() {
  const assembledWords = [...assembledWordsDiv.children].map(w => w.dataset.word);
  const correctSentence = assembledWordsDiv.dataset.correctSentence.split(' ');
  if (assembledWords.length !== correctSentence.length) return;

  for(let i = 0; i < correctSentence.length; i++) {
    if(assembledWords[i] !== correctSentence[i]) return;
  }

  clearInterval(jumbleTimerInterval);
  jumbleTimerDiv.textContent = '';
  if (!timeLimitExceeded) {
    result.textContent = 'Excellent! Correct answer! +1 Mark';
    totalScore++;
    levelScore++;
  } else {
    result.textContent = 'Correct! But time exceeded. No mark.';
  }
  jumbleContentWrapper.classList.add('hidden');
  correctSentenceBox.classList.add('active');
  correctSentenceText.textContent = currentSentence;
  showSentenceBtn.style.display = 'none';
  nextSentenceBtn.style.display = 'inline-block';
}

function showScorePage() {
  scorePageContainer.classList.add('active');
  sentenceBox.style.display = 'none';
  spokenSentenceBox.classList.remove('active');
  jumbleContainer.style.display = 'none';
  correctSentenceBox.classList.remove('active');
  buttons.style.display = 'none';
  result.textContent = '';

  levelScoreContent.innerHTML = `
    <div>Level ${currentLevel + 1} Score</div>
    <div style="font-size: 32px; margin: 20px 0; font-weight: 900; color: #e74c3c;">${levelScore} / 6</div>
  `;

  if (currentLevel < allLevels.length - 1) {
    continueBtn.style.display = 'inline-block';
    restartBtn.style.display = 'inline-block';
  } else {
    levelScoreContent.innerHTML = `
      <div style="font-size: 28px; margin: 20px 0;">All Levels Complete!</div>
      <div style="font-size: 24px; margin: 20px 0;">Total Score: <strong style="color: #e74c3c;">${totalScore} / 18</strong></div>
    `;
    continueBtn.style.display = 'none';
    restartBtn.style.display = 'inline-block';
  }
}

speakBtn.onclick = () => {
  if (!micAllowed || !recognition) {
    alert('Speech Recognition not initialized. Please refresh the page.');
    return;
  }
  if(recognitionActive) {
    recognition.stop();
    recognitionActive = false;
    speakBtn.textContent = 'Speak';
    result.textContent = '';
    spokenSentenceBox.classList.remove('active');
    playbackBtn.disabled = true;
    return;
  }
  try {
    recognition.start();
    playbackBtn.disabled = true;
  } catch (e) {
    console.error('Recognition start error:', e);
    result.textContent = 'Please wait and try again.';
  }
};

repeatBtn.onclick = () => {
  const utterance = new SpeechSynthesisUtterance(currentSentence);
  utterance.lang = 'en-US';
  speechSynthesis.speak(utterance);
};

recallBtn.onclick = () => {
  showJumbleActivity(currentSentence.split(' '));
};

retryBtn.onclick = () => {
  result.textContent = '';
  spokenSentenceBox.classList.remove('active');
  retryBtn.style.display = 'none';
  playbackBtn.disabled = true;
  speakBtn.style.display = 'inline-block';
  repeatBtn.style.display = 'inline-block';
};

showSentenceBtn.onclick = () => {
  sentenceBox.classList.remove('hidden');
  fadeInSentence(currentSentence);
  showSentenceBtn.style.display = 'none';
  nextSentenceBtn.style.display = 'inline-block';
};

playbackBtn.onclick = () => {
  if (audioBlob) {
    const audioUrl = URL.createObjectURL(audioBlob);
    const audio = new Audio(audioUrl);
    audio.play().catch(err => {
      console.error('Error playing audio:', err);
      alert('Could not play audio. Please try again.');
    });
  } else {
    alert('No audio recording available.');
  }
};

nextSentenceBtn.onclick = () => {
  currentQuestion++;
  jumbleContainer.style.display = 'none';
  jumbleContentWrapper.classList.remove('hidden');
  correctSentenceBox.classList.remove('active');
  showSentenceBtn.style.display = 'none';
  nextSentenceBtn.style.display = 'none';
  jumbleTimerDiv.textContent = '';
  result.textContent = '';
  spokenSentenceBox.classList.remove('active');
  playbackBtn.disabled = true;

  if (currentQuestion >= 3) {
    showScorePage();
  } else {
    showQuestion();
  }
};

continueBtn.onclick = () => {
  currentLevel++;
  currentQuestion = 0;
  levelScore = 0;
  scorePageContainer.classList.remove('active');
  sentenceBox.style.display = 'flex';
  buttons.style.display = 'block';
  speakBtn.style.display = 'inline-block';
  repeatBtn.style.display = 'inline-block';
  continueBtn.style.display = 'none';
  restartBtn.style.display = 'none';

  showLevel();
};

restartBtn.onclick = () => {
  startReadingPractice();
};

window.onload = () => {
  startReadingPractice();
};
</script>
</body>
</html>
